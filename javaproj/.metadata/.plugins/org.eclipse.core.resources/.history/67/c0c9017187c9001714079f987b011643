package szpital;

import java.sql.SQLException;
import java.util.Scanner;

public class LS {

	DB db;
	Scanner rl;
	Lekarze L;
	Specjalnosci S;
	
	LS(DB db, Scanner rl, Lekarze L, Specjalnosci S){
		this.db=db;
		this.rl=rl;
		this.S=S;
		this.L=L;
	}
	
	public String print(){
		String res="";
		
		res+=String.format("%-5s|%-45s|%-20s\n", "ID","Lekarz","Specjalnoœæ");
		res+="------------------------------------------------------------------------\n";
		try {
			while (db.getRs().next()){
				res+=String.format("%-5s|%-45s|%-20s\n"
						        , db.getRs().getString(1)
								, db.getRs().getString(2)
								, db.getRs().getString(3)
						);
			}
		} catch (SQLException ex) {
			res+="Wyst¹pi³ b³¹d !\n";
		}
			
		return res;
	}

	@Override
	public String toString(){
		String sql="select idls, lekarz, nazwaspecjalnosci from v_lekarzespecjalnosci ;";
		if (db.select(sql)){
			return this.print();
		};
		return "Coœ posz³o nie tak... :-(";
	}
	
	public boolean check(String idl, String ids){
		String sql=String.format(
				"select * from lekarzespecjalnosci where idlekarza=%s and idspecjalnosci=%s;",
				idl, ids);
		return db.select(sql) && (db.next());
	}
	
	public boolean check(int idls){
		String sql=String.format(
				"select * from lekarzespecjalnosci where idls=%d;",
				idls);
		return db.select(sql) && (db.next());
	}
	
	public boolean del(int idls){
		String sql=String.format(
				"delete from lekarzespecjalnosci where idls=%d; "
				,idls);
		
		return db.execute(sql) && db.commit();
	}
	
	public boolean ask_del(){
		System.out.println("Usuwanie przypisania, lista przypisañ :");
		System.out.println(this);
		do {
			System.out.println("Podaj identyfikator przypisania do usuniêcia (<0 - przerwanie):");
			int id=Tools.nextInt(this.rl, "Identyfikator musi byc liczb¹!");
			if (id<0){
				System.out.println("Przerwanie!");
				break;
			}
			if (check(id)) {
				//System.out.println("Znaleziono taki ID!");
				boolean res=del(id);
				if (res)
					System.out.println("Usuniêto!");
				else
					System.out.println("Wyst¹pi b³¹d!");
				return res;
			}
			System.out.println("Nie znaleziono takiego ID, spróbuj ponownie...");
		} while (true);
		return true;
	}
	
	public boolean add(int idlekarza, int idspecjalnosci){
		String sql=String.format(
				"insert into lekarzespecjalnosci(idlekarza, idspecjalnosci) "
				+ "values(%d,%d);"
						,idlekarza, idspecjalnosci);
		
		return db.execute(sql) && db.commit();
	}
	
	public void ask_add(){
		int idlekarza;
		int idspecjalnosci;
		
		System.out.println("Dodawanie przypisania specjalnoœci do lekarza");
		System.out.println("Lista lekarzy:");System.out.println(L);
		
		do {
			System.out.println("Podaj identyfikator lekarza  (<0-wyjœcie) :"); idlekarza=Tools.nextInt(this.rl,"Identyfikator musi byæ liczb¹!");
			if (idlekarza<0){
				System.out.println("Przerwanie!");
				return;
			} 
			if (L.check(idlekarza)) break;
			else
				System.out.println("Nie ma takiego identyfikatora, spróbuj ponownie...");
		} while (true);
		
		System.out.println("Lista specjalnoœci:");System.out.println(S);
		do {
			System.out.println("Podaj identyfikator specjalnoœci  (<0-wyjœcie) :"); idspecjalnosci=Tools.nextInt(this.rl,"Identyfikator musi byæ liczb¹!");
			if (idspecjalnosci<0){
				System.out.println("Przerwanie!");
				return;
			} 
			if (S.check(idspecjalnosci)) break;
			else
				System.out.println("Nie ma takiego identyfikatora, spróbuj ponownie...");
		} while (true);
			
		if (this.add(idlekarza, idspecjalnosci)) System.out.println("Dodano !"); else System.out.println("Wyst¹pi³ b³¹d!");
			return;					
	}
}
